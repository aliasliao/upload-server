// ÂÖ®Â±ÄÂèòÈáè
let currentUploads = new Map();

// DOMÂÖÉÁ¥†
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const selectBtn = document.getElementById('selectBtn');
const uploadProgress = document.getElementById('uploadProgress');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const uploadStatus = document.getElementById('uploadStatus');
const uploadDetails = document.getElementById('uploadDetails');
const uploadedSize = document.getElementById('uploadedSize');
const totalSize = document.getElementById('totalSize');
const uploadSpeed = document.getElementById('uploadSpeed');
const elapsedTime = document.getElementById('elapsedTime');
const filesContainer = document.getElementById('filesContainer');
const serverInfo = document.getElementById('serverInfo');
const notification = document.getElementById('notification');

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    loadServerInfo();
    loadFiles();
    setupEventListeners();
});

// ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
function setupEventListeners() {
    // ÊãñÊãΩ‰∏ä‰º†
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    
    // ÁÇπÂáª‰∏ä‰º†Âå∫ÂüüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©ÔºàÊéíÈô§ÊåâÈíÆÂå∫ÂüüÔºâ
    uploadArea.addEventListener('click', handleUploadAreaClick);
    
    // ÈÄâÊã©Êñá‰ª∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    selectBtn.addEventListener('click', () => fileInput.click());

    // Êñá‰ª∂ÈÄâÊã©
    fileInput.addEventListener('change', handleFileSelect);
}

// Â§ÑÁêÜÊãñÊãΩÊÇ¨ÂÅú
function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
}

// Â§ÑÁêÜÊãñÊãΩÁ¶ªÂºÄ
function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
}

// Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩ
function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
        uploadFiles(files);
    }
}

// Â§ÑÁêÜ‰∏ä‰º†Âå∫ÂüüÁÇπÂáª
function handleUploadAreaClick(e) {
    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÔºå‰∏çËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
    if (e.target.closest('.select-btn')) {
        return;
    }
    
    // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
    fileInput.click();
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
        uploadFiles(files);
    }
}

// ‰∏ä‰º†Êñá‰ª∂
async function uploadFiles(files) {
    showUploadProgress();
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        await uploadSingleFile(file, i + 1, files.length);
    }
    
    // ‰∏ä‰º†ÂÆåÊàêÂêéÂà∑Êñ∞Êñá‰ª∂ÂàóË°®
    setTimeout(() => {
        hideUploadProgress();
        loadFiles();
        showNotification('ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†ÂÆåÊàêÔºÅ', 'success');
    }, 1000);
}

// ‰∏ä‰º†Âçï‰∏™Êñá‰ª∂
async function uploadSingleFile(file, currentIndex, totalFiles) {
    const formData = new FormData();
    formData.append('file', file);
    
    const uploadId = Date.now() + Math.random();
    currentUploads.set(uploadId, { file, progress: 0 });
    
    try {
        updateUploadStatus(`Ê≠£Âú®‰∏ä‰º† ${file.name} (${currentIndex}/${totalFiles})`);
        
        const xhr = new XMLHttpRequest();
        let startTime = Date.now();
        let lastProgressUpdate = 0;
        
        // ÁõëÂê¨‰∏ä‰º†ÂºÄÂßã
        xhr.upload.addEventListener('loadstart', () => {
            console.log(`üöÄ ÂºÄÂßã‰∏ä‰º†: ${file.name}`);
            startTime = Date.now();
            lastProgressUpdate = startTime;
        });
        
        // ÁõëÂê¨‰∏ä‰º†ËøõÂ∫¶ - ËøôÊòØÁúüÂÆûÁöÑ‰∏ä‰º†ËøõÂ∫¶
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const currentTime = Date.now();
                const progress = Math.round((e.loaded / e.total) * 100);
                const receivedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                const totalMB = (e.total / (1024 * 1024)).toFixed(2);
                const elapsed = (currentTime - startTime) / 1000;
                
                // ËÆ°ÁÆó‰∏ä‰º†ÈÄüÂ∫¶
                let speed = '0.00';
                if (elapsed > 0) {
                    speed = (e.loaded / (1024 * 1024) / elapsed).toFixed(2);
                }
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÂíåËØ¶ÁªÜ‰ø°ÊÅØ
                updateProgress(progress);
                updateUploadDetails(receivedMB, totalMB, progress);
                updateUploadStatus(`Ê≠£Âú®‰∏ä‰º† ${file.name} (${currentIndex}/${totalFiles}) - ${progress}% (${receivedMB}/${totalMB} MB) - ÈÄüÂ∫¶: ${speed} MB/s`);
                
                // ÊØè500msÂú®ÊéßÂà∂Âè∞ËæìÂá∫‰∏ÄÊ¨°ËØ¶ÁªÜËøõÂ∫¶
                if (currentTime - lastProgressUpdate > 500) {
                    console.log(`üìä ÁúüÂÆû‰∏ä‰º†ËøõÂ∫¶ - ${file.name}: ${progress}% (${receivedMB}/${totalMB} MB) - ÈÄüÂ∫¶: ${speed} MB/s - Â∑≤Áî®Êó∂: ${elapsed.toFixed(1)}s`);
                    lastProgressUpdate = currentTime;
                }
                
                currentUploads.get(uploadId).progress = progress;
            }
        });
        
        // ÁõëÂê¨‰∏ä‰º†ÂÆåÊàê
        xhr.addEventListener('load', () => {
            const totalTime = (Date.now() - startTime) / 1000;
            
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    updateUploadStatus(`‚úÖ ${file.name} ‰∏ä‰º†ÊàêÂäü - ÊÄªÁî®Êó∂: ${totalTime.toFixed(1)}s`);
                    showNotification(`${file.name} ‰∏ä‰º†ÊàêÂäü`, 'success');
                    
                    // ÊòæÁ§∫ÊúçÂä°Âô®Á´ØÁöÑÊúÄÁªàÁªüËÆ°‰ø°ÊÅØ
                    if (response.finalProgress) {
                        console.log(`üìÅ ÊúçÂä°Âô®Á´ØÁªüËÆ° - ${file.name}: ${response.finalProgress.receivedMB} MB, Âπ≥ÂùáÈÄüÂ∫¶: ${response.finalProgress.speed} MB/s`);
                    }
                } else {
                    updateUploadStatus(`‚ùå ${file.name} ‰∏ä‰º†Â§±Ë¥•: ${response.message}`);
                    showNotification(`${file.name} ‰∏ä‰º†Â§±Ë¥•: ${response.message}`, 'error');
                }
            } else {
                updateUploadStatus(`‚ùå ${file.name} ‰∏ä‰º†Â§±Ë¥•`);
                showNotification(`${file.name} ‰∏ä‰º†Â§±Ë¥•`, 'error');
            }
            currentUploads.delete(uploadId);
        });
        
        // ÁõëÂê¨‰∏ä‰º†ÈîôËØØ
        xhr.addEventListener('error', () => {
            updateUploadStatus(`‚ùå ${file.name} ‰∏ä‰º†Â§±Ë¥•`);
            showNotification(`${file.name} ‰∏ä‰º†Â§±Ë¥•`, 'error');
            currentUploads.delete(uploadId);
        });
        
        xhr.open('POST', '/upload');
        xhr.send(formData);
        
    } catch (error) {
        updateUploadStatus(`‚ùå ${file.name} ‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
        showNotification(`${file.name} ‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'error');
        currentUploads.delete(uploadId);
    }
}

// ‰ªéÊúçÂä°Âô®ËøõÂ∫¶Êõ¥Êñ∞UI
function updateProgressFromServer(progress, fileName) {
    if (progress) {
        updateProgress(progress.progress);
        updateUploadDetails(progress.receivedMB, progress.totalMB, progress.progress);
        updateUploadStatus(`Ê≠£Âú®‰∏ä‰º† ${fileName} - ${progress.progress}% (${progress.receivedMB}/${progress.totalMB} MB) - ÈÄüÂ∫¶: ${progress.speed} MB/s`);
        
        if (progress.status === 'completed') {
            updateUploadStatus(`‚úÖ ${fileName} ‰∏ä‰º†ÂÆåÊàê - ÊÄªÁî®Êó∂: ${progress.elapsed}s, Âπ≥ÂùáÈÄüÂ∫¶: ${progress.speed} MB/s`);
        }
    }
}

// Ëé∑ÂèñÊúçÂä°Âô®Á´Ø‰∏ä‰º†ËøõÂ∫¶
async function getServerProgress(uploadId, fileName) {
    try {
        const response = await fetch(`/upload-progress/${uploadId}`);
        const data = await response.json();
        
        if (data.success && data.progress) {
            const progress = data.progress;
            console.log(`üìä ÊúçÂä°Âô®Á´ØËøõÂ∫¶ - ${fileName}: ${progress.progress}% (${progress.receivedMB}/${progress.totalMB} MB) - ÈÄüÂ∫¶: ${progress.speed} MB/s`);
            
            if (progress.status === 'completed') {
                updateUploadStatus(`‚úÖ ${fileName} ‰∏ä‰º†ÂÆåÊàê - ÊÄªÁî®Êó∂: ${progress.elapsed}s, Âπ≥ÂùáÈÄüÂ∫¶: ${progress.speed} MB/s`);
            }
        }
    } catch (error) {
        console.error('Ëé∑ÂèñÊúçÂä°Âô®ËøõÂ∫¶Â§±Ë¥•:', error);
    }
}

// ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
function showUploadProgress() {
    uploadProgress.style.display = 'block';
    uploadDetails.style.display = 'none';
    updateProgress(0);
    updateUploadStatus('ÂáÜÂ§á‰∏ä‰º†...');
    window.uploadStartTime = null;
}

// ÈöêËóè‰∏ä‰º†ËøõÂ∫¶
function hideUploadProgress() {
    uploadProgress.style.display = 'none';
    uploadDetails.style.display = 'none';
}

// Êõ¥Êñ∞ËøõÂ∫¶Êù°
function updateProgress(percent) {
    progressFill.style.width = percent + '%';
    progressText.textContent = percent + '%';
}

// Êõ¥Êñ∞‰∏ä‰º†Áä∂ÊÄÅ
function updateUploadStatus(message) {
    uploadStatus.textContent = message;
}

// Êõ¥Êñ∞‰∏ä‰º†ËØ¶ÁªÜ‰ø°ÊÅØ
function updateUploadDetails(receivedMB, totalMB, progress) {
    uploadedSize.textContent = receivedMB + ' MB';
    totalSize.textContent = totalMB + ' MB';
    uploadDetails.style.display = 'grid';
    
    // ËÆ°ÁÆó‰∏ä‰º†ÈÄüÂ∫¶ÔºàÁÆÄÂåñÁâàÊú¨Ôºâ
    const currentTime = Date.now();
    if (!window.uploadStartTime) {
        window.uploadStartTime = currentTime;
    }
    
    const elapsed = (currentTime - window.uploadStartTime) / 1000;
    const speed = elapsed > 0 ? (parseFloat(receivedMB) / elapsed).toFixed(2) : '0.00';
    
    uploadSpeed.textContent = speed + ' MB/s';
    elapsedTime.textContent = elapsed.toFixed(1) + 's';
}

// Âä†ËΩΩÊúçÂä°Âô®‰ø°ÊÅØ
async function loadServerInfo() {
    try {
        const response = await fetch('/server-info');
        const data = await response.json();
        
        const infoHtml = `
            <div class="info">
                <div>Á´ØÂè£: ${data.port}</div>
                <div>ÂÜÖÁΩëÂú∞ÂùÄ: ${data.localIPs.join(', ')}</div>
            </div>
        `;
        
        serverInfo.innerHTML = infoHtml;
    } catch (error) {
        serverInfo.innerHTML = '<span class="error">Êó†Ê≥ïËé∑ÂèñÊúçÂä°Âô®‰ø°ÊÅØ</span>';
    }
}

// Âä†ËΩΩÊñá‰ª∂ÂàóË°®
async function loadFiles() {
    try {
        filesContainer.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÊñá‰ª∂ÂàóË°®...</div>';
        
        const response = await fetch('/files');
        const data = await response.json();
        
        if (data.success) {
            displayFiles(data.files);
        } else {
            filesContainer.innerHTML = '<div class="error">Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•</div>';
        }
    } catch (error) {
        filesContainer.innerHTML = '<div class="error">Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•</div>';
    }
}

// ÊòæÁ§∫Êñá‰ª∂ÂàóË°®
function displayFiles(files) {
    if (files.length === 0) {
        filesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>ÊöÇÊó†‰∏ä‰º†ÁöÑÊñá‰ª∂</p>
            </div>
        `;
        return;
    }
    
    const filesHtml = files.map(file => {
        const fileIcon = getFileIcon(file.filename);
        const fileSize = formatFileSize(file.size);
        const uploadTime = new Date(file.uploadTime).toLocaleString('zh-CN');
        
        return `
            <div class="file-item">
                <i class="file-icon ${fileIcon}"></i>
                <div class="file-info">
                    <div class="file-name">${file.filename}</div>
                    <div class="file-meta">
                        <span>Â§ßÂ∞è: ${fileSize}</span>
                        <span>‰∏ä‰º†Êó∂Èó¥: ${uploadTime}</span>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="action-btn download" onclick="downloadFile('${file.filename}')" title="‰∏ãËΩΩ">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteFile('${file.filename}')" title="Âà†Èô§">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    filesContainer.innerHTML = filesHtml;
}

// Ëé∑ÂèñÊñá‰ª∂ÂõæÊ†á
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint',
        'pptx': 'fas fa-file-powerpoint',
        'txt': 'fas fa-file-alt',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'mp4': 'fas fa-file-video',
        'avi': 'fas fa-file-video',
        'mp3': 'fas fa-file-audio',
        'zip': 'fas fa-file-archive',
        'rar': 'fas fa-file-archive',
        '7z': 'fas fa-file-archive'
    };
    
    return iconMap[ext] || 'fas fa-file';
}

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ‰∏ãËΩΩÊñá‰ª∂
function downloadFile(filename) {
    window.open(`/download/${encodeURIComponent(filename)}`, '_blank');
}

// Âà†Èô§Êñá‰ª∂
async function deleteFile(filename) {
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂ "${filename}" ÂêóÔºü`)) {
        return;
    }
    
    try {
        const response = await fetch(`/files/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Êñá‰ª∂Âà†Èô§ÊàêÂäü', 'success');
            loadFiles();
        } else {
            showNotification('Êñá‰ª∂Âà†Èô§Â§±Ë¥•: ' + data.message, 'error');
        }
    } catch (error) {
        showNotification('Êñá‰ª∂Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
    }
}

// ÊòæÁ§∫ÈÄöÁü•
function showNotification(message, type = 'info') {
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
} 